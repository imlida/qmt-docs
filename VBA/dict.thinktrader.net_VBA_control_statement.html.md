---
url: "https://dict.thinktrader.net/VBA/control_statement.html"
title: "控制语句 | 迅投知识库"
---

模型平台是个强大的脚本执行平台，除了我们在基础教程部分介绍的顺序执行语句外，可以执行带条件分支和循环以及无条件跳转等功能，模型量化交易版在工作时，由于内部运行机制不同，分为序列模式以及逐K线模式，我们这里先从序列模式介绍公式系统的运行机理，逐K线模式我们在后面会另有介绍。下面我们将逐步向大家介绍如何使用模型中的控制语句编写模型。

### [\#](https://dict.thinktrader.net/VBA/control_statement.html\#%E5%BA%8F%E5%88%97%E5%8F%98%E9%87%8F%E4%B8%8E%E6%95%B0%E7%BB%84) 序列变量与数组

在模型公式系统中，需要大量运用并区分数组、单值变量及序列变量的概念，这些概念也是进一步学习编程所必需的，因此有必要简单描述并初步掌握这些概念。

#### [\#](https://dict.thinktrader.net/VBA/control_statement.html\#%E5%B8%B8%E6%95%B0%E4%B8%8E%E5%8D%95%E5%80%BC%E5%8F%98%E9%87%8F) 常数与单值变量

常数，在模型编辑器中，就是不允许改变的数值，在我们平常写公式时，为了公式更加灵活，大量使用了参数，这些参数就是常数，不允许在公式中改变，比如参数n(1,1,25)， 表示参数n最小值是1、最大值是25、默认值是1，如果在公式中再写一行“n:=30;”就是非法的。

单值变量，即只有一个数值，不随时间而改变，比如“x:100;”，就是定义了一个单值变量x=100，这个值不随时间而改变，做成副图指标看，今天x是100明天x也是100，直到最后1 根K线也是100。

#### [\#](https://dict.thinktrader.net/VBA/control_statement.html\#%E6%95%B0%E7%BB%84) 数组

系统中，和常规数组概念不同并非构建单纯的有序数据的集合，通过数组可以建立有序的一一对应关系。通过这种对应关系，数组结构可以定义多样的对应关系，如常规数组 A{1,2,3,4,5...}~{34,235,234,626,666...}，从而得到 A\[1\]=34,A\[2\]=235...;也可以定义不同的数据类型的下标和数组值来构成对应关系,如例如对于数组 B{'SH6000000', 'SZ000001'...}~{＇上海＇＇深圳＇...},从而有 B\[SH600000\]=上海...

一般来说，数组的使用，要先定义，然后初始化（即赋予数组的每个元素一个初始的数据）。在模型量化交易版中，目前只支持一维数组，并且下标是从 1 开始的。

在模型量化交易版中,如何定义初始化并使用数组?

示例1: 定义一个含 10 个元素的数值型数组

定义数组的语句是 variable,公式代码如下：

```
variable:A[10]=0; //定义一个含 10 个元素的数值型数组 A，并把所有元素初始化为 0;
```

示例2: 定义一个 3 个元素的字符串型的数组

公式代码如下：

```
variable:B[3]='abc'; //定义一个含 3 个元素的字符串型数组 B，并把所有元素初始化为'abc'
```

示例3: 把{1,3,5,7,9}定义为数组

分析：这组数据共有 5 个数值型数据，因此应定义长度为 5 的数组，并给每个元素赋值。 公式代码如下：

```
variable:A[5]=0;
A[1]:=1;
A[2]:=3;
A[3]:=5;
A[4]:=7;
A[5]:=9;
```

前面所举的关于数组的例子,都是概念性的,单纯数组的应用一般都比较复杂，比如，从每天的分笔成交中统计，各个成交价位成交的笔数。等到后面讲完循环有机会时再写具体的代码。

提示

对于使用 for 循环类的函数对数组执行循环赋值时，可以不设置下标顺序，系统会依据数组下标在系统中存储的值的大小顺序依次遍历。

#### [\#](https://dict.thinktrader.net/VBA/control_statement.html\#%E5%BA%8F%E5%88%97%E5%8F%98%E9%87%8F) 序列变量

我们平时接触最多的是收盘价 close，写一行代码“fc:close"，就是定义了一个变量 fc， 并把收盘价赋值给变量 fc。这里变量 fc 就是序列变量，因为 fc 不是一个值，而是一序列随时间而变化的值(收盘价)，在K 线图中，从第 1 根 K 线到最后 1 根 K 线都有一个收盘价，因此fc 跟单值变量不同，是由一系列的值组成的变量，因此我们称之为序列变量。事实上，把 “fc:close”这行代码做成一个指标，就可以看出 fc 是一条变化的曲线而不是一条水平直线。

量化交易版公式编辑系统中，可以把序列变量等同于一个数组，这是一个特殊的数组，这个数组的最小下标是从序列变量的起始有效位置开始，数组的最大下标是 K 线数量， 其中 K 线的数量，可以从 datacount 函数得到。

比如“fc:close;"，这行代码，可以把 fc 看成是一个下标从 1 开始直到 datacount 的数组。如果我们想知道第 1、2、5、最后 1 根 K 线的收盘价，可以写成如下代码：

```
fc:=close;//定义一个序列变量，相当于是一个数组
k1:fc[1];//第１根 K 线的收盘价
k2:fc[2];//第 2 根 K 线的收盘价
k3:fc[5];//第 5 根 K 线的收盘价
k_end:fc[datacount];//最后 1 根 K 线的收盘价
```

### [\#](https://dict.thinktrader.net/VBA/control_statement.html\#%E5%BE%AA%E7%8E%AF%E8%AF%AD%E5%8F%A5) 循环语句

量化交易版中的循环语句有两个类别，一个是 FOR TO … ，另一个是REPEATUNTIL …，这里我们重点介绍FOR循环，REPEAT UNTIL的例子，用户请自行在量化交易版公式编辑器中软件函数列表中查看使用方法。

#### [\#](https://dict.thinktrader.net/VBA/control_statement.html\#for%E9%80%92%E5%A2%9E%E5%BE%AA%E7%8E%AF) FOR递增循环

先从一个的实例开始，求当前股票收盘价的2日算术平均价，为了方便起见，以刚上市不久的603798康普顿来说明，首先定义序列变量fc为收盘价，根据上一讲我们知道，fc可以看成是一个数组，因此，数组fc的每一个元素如下表所示：

```
603798 康普顿
         时间    收盘
fc[1] 2016/04/06 20.64
fc[2] 2016/04/07 22.70
fc[3] 2016/04/08 24.97
fc[4] 2016/04/11 27.47
fc[5] 2016/04/12 30.22
fc[6] 2016/04/13 33.24
```

显然， 2日平均收盘价必须是从第2根K线即上市后第2日开始，到最后一天结束，设2日平均股价用序列变量ma2来表示，由于2日平均收盘价等于当日收盘价加昨收盘除以2，如果手工一行一行来写代码计算，则：

```
ma2[2]:=(fc[1]+fc[2])/2; //今收盘与昨收盘之和除以2，等于今2日平均收盘价
ma2[3]:=(fc[2]+fc[3])/2;
ma2[4]:=(fc[3]+fc[4])/2;
ma2[5]:=(fc[4]+fc[5])/2;
ma2[6]:=(fc[5]+fc[6])/2;

分析上面代码，2日平均价的计算特点是：
① 从第2根K线开始计算的
② 每天的均价都等于(今收盘+昨收盘)/2
③ 直到最后1根K线结束
```

容易知道，如果有1000根K线，则要写999行代码，显然效率太低了。我们来找找规律，如果是中间的某天即第i天，则上面的表达式可以写为

```
ma2[i]:=(fc[i-1]+fc[i])/2;
```

这个i是从第2根K线开始直到最后1根K线。这些计算都是重复同样的计算，只不过i不同罢了。如果有一种方法，可以自动重复计算这些表达式，并且每重复一次，i自动增加1，就可以达到目的了。由此我们定义一种循环语句，可以自动循环、重复运行某一行代码。在迅投量化投研平台中，循环语句有2种，下面先介绍FOR循环语句

语法：

```
FOR var=n1 TO n2 DO expr;
{从 var=n1 开始，直到 var=n2，开始循环执行 expr 语句，每执行一次var加1。这里，var称之为循环变量。}
```

用循环语句表达上面计算2日平均收盘价，公式代码如下：

```
fc:=close; //定义序列变量fc为收盘价
for i=2 to datacount do ma2[i] :=(fc[i-1]+fc[i])/2;
//从i=2到i=datacount循环执行ma2[i] :=(fc[i-1]+fc[i])/2
```

#### [\#](https://dict.thinktrader.net/VBA/control_statement.html\#for%E9%80%92%E5%A2%9E%E5%BE%AA%E7%8E%AF-1) FOR递增循环

上面的FOR循环，循环变量是每次递增1，可称之为递增FOR循环。还有一种FOR循环是递减FOR循环，循环变量是每次递减1，语法如下：

```
FOR var=n1 DOWNTO n2 DO expr2;
{从 var=n1 开始到 var=n2 开始循环执行 expr 语句，每执行一次var减1}
```

上面我们设计2日平均收盘价的公式时，是从前面往后面计算的，仔细想想，其实也可以从后面往前面计算，公式代码如下：

```
fc:=close;
for i=datacount downto 2 do ma2[i] :=(fc[i-1]+fc[i])/2;
```

### [\#](https://dict.thinktrader.net/VBA/control_statement.html\#%E5%A4%8D%E5%90%88%E8%AF%AD%E5%8F%A5) 复合语句

复合语句注释: 把多条语句看作一条语句

语法:BEGIN...END

这里，begin和end是成对出现的，被begin和end包围起来的语句可以有很多条，这些语句可以看成是一条复合语句。

下面我们用begin…end来改写递增循环计算2日平均收盘价的公式：

```
fc:=close; //定义序列变量为收盘价
for i=2 to datacount do
begin
a:= fc[i-1]+fc[i]; //定义一个临时的单值变量a，保存中间计算结果
ma2[i] := a/2;
end;
```

这段代码，就是由2行代码组成的复合语句，被循环执行若干次。为了代码容易分辨，我们特别把复合语句中的2行代码，都向右缩了4格，表明这是2行复合语句，是被循环语句所控制的。以前对于这类分层次的语句，都要进行缩格，便于看懂代码，特别是复杂的代码，如果不进行缩格，时间久了，恐怕连自己都很难看懂，大家一开始就要养成好习惯。

有人会问，书写代码不缩格行吗？不缩格公式会不会出错？答案是，缩格书写代码，仅仅是为了方便看清程序代码的逻辑层次，对公式的运行没有影响。

有了复合语句，循环的功能就更加强大了，可以轻松实现多重循环，即循环中套循环。在计算N日的平均价时会用到，如果事先不知道N是多少，就要用到二重循环。对于循环中要执行的语句，如果重复太多，也可以使用多重循环来简化。以二重循环为例，大致结构如下：

```
for i=n1 to n2 do
begin
语句;
…
for j=m1 to m2 do
begin
语句;
…
end;
语句;
…
end;
```

### [\#](https://dict.thinktrader.net/VBA/control_statement.html\#%E6%9D%A1%E4%BB%B6%E8%AF%AD%E5%8F%A5) 条件语句

条件语句的语法如下：

IF条件语句

语法:IF cond THEN expr1 ELSE expr2

如果cond 条件成立，则执行语句 expr1，否则执行 expr2 语句。

说明

```
1、在条件判断比较简单的情况下，ELSE expr2 子句可以省略。
2、条件 cond 可以是单值变量，也可以为序列变量。当为序列变量时，cond将取最后一个周期的值做为条件判断语句。条件语句的语法比较简单，但使用时却容易出错，下面举若干
```

条件语句的语法比较简单，但使用时却容易出错，下面举若干示例。

例1：修改成交量公式VOL，当流通盘不为零且当前周期为日以上周期时，显示换手率，代码参考如下（仿此，大家绕过指标模组，可以自行设计，“绑定”到周期、券种等的公式）

代码:

```
VOL,VOLSTICK;
MA1:MA(VOL,M1);
MA2:MA(VOL,M2);
MA3:MA(VOL,M3);
if capital>0 and DATATYPE>=6 then
换手率:vol/capital; //日以上周期及非指数个股，显示换手率
```

当切换到60分钟及以下周期，或者切换到大盘（此时流通盘＝0），会发现“换手率”指标线、名称及数值都不显示。

以上是较简单的情况，没有使用 ELSE expr2 子句。上面代码稍加改进，使用复合语句，使之适用于任意周期：

例2，修改成交量公式，流通盘不为0时，显示换手率（60分钟及以下周期，计算当日最新的换手率），代码参考如下：

代码:

```
VOL,VOLSTICK;
MA1:MA(VOL,M1);
MA2:MA(VOL,M2);
MA3:MA(VOL,M3);
IF CAPITAL>0 then //如果换手率＞0,则
IFDATATYPE>=6 then //如果周期为日及以上的较长周期,则
b:=VOL/CAPITAL*100;
else //否则
begin //复合语句开始，即以下3条语句，视为1条语句，end表示复合语句结束
tj:=DAY>REF(DAY,1) or BARSSINCE(CLOSE)=0;
ts:=BARSLAST(tj)+1;
b:=SUM(VOL,ts)/CAPITAL*100;
end;
换手率:b;
```

例3、通过参数N，控制调整均线数，代码参考如下：

代码:

```
input:p1(5,0,300),p2(10,0,300),p3(20,0,300),p4(30,0,300),n(4,1,4);{参数定义}
IF n>0 then MA1:MA(CLOSE,P1);{如果n>=1则输出ma1指标线}
IF n>1 then MA2:MA(CLOSE,P2);{如果n>=2则输出ma1指标线}
IF n>2 then MA3:MA(CLOSE,P3);{如果n>=3则输出ma1指标线}
IF n>3 then MA4:MA(CLOSE,P4);{如果n>=4则输出ma1指标线}
```

在使用条件语句“IF cond THEN”中，序列模式下，cond如果是序列变量，那么IF语句只取最后序列值做为条件判断，比如：

代码:

```
fc:=close;
fo:=open;
if fc>fo then //这里的fc、fo是序列变量，因此只取最后一个周期的条件做为判断依
据
xx:=1；
else
xx:=0;
y:xx;
```

这里，if fc>fo then 这种写法的本意是，“如果收盘价大于开盘价则”，是针对序列变量的每个数据（相当于数组的每个元素），但是在序列模式下是不会得到执行结果的，在模型终端公式编辑器的序列模式运行中，正确的写法应该是这样的：

代码:

```
//如果xx是序列变量，则代码参考如下
fc:=close;
fo:=open;
for i=1 to datacount do
begin
if fc[i]>fo[i] then
xx[i]:=1; //请注意这里跟上面代码的不同
else
xx[i]:=0;
end
y:xx;
```